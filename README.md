# Diplodoc page-constructor extension

[![NPM version](https://img.shields.io/npm/v/@diplodoc/page-constructor-extension.svg?style=flat)](https://www.npmjs.org/package/@diplodoc/page-constructor-extension)

This is an extension of the Diplodoc platform, which allows using the [Page Constructor](https://github.com/gravity-ui/page-constructor) component from Gravity UI in your documentation. Page Constructor is a library for rendering web pages or their parts based on YAML data. This extension enables creating rich, interactive page layouts with various block types directly in your markdown files.

The extension contains some parts:

- [Prepared runtime](#prepared-runtime)
- [MarkdownIt transform plugin](#markdownit-transform-plugin)
- [React component for rendering](#react-component-for-rendering)

## Quickstart

Attach the plugin to the transformer:

```js
import pageConstructorExtension from '@diplodoc/page-constructor-extension';
import transform from '@diplodoc/transform';

const {result} = await transform(
  `
::: page-constructor
blocks:
  - type: 'header-block'
    title: 'My Header'
    description: 'This is a description'
:::
`,
  {
    plugins: [pageConstructorExtension.transform({bundle: false})],
  },
);
```

Don't forget to add the runtime to make page constructor interactive:

```js
// Import the runtime in your application
import '@diplodoc/page-constructor-extension/runtime'
import '@diplodoc/page-constructor-extension/runtime/styles.css'

// Or include it in your HTML
<script src='_assets/page-constructor.js'></script>
<link rel='stylesheet' href='_assets/page-constructor.css' />
```

## Syntax

You can use the page constructor in your markdown files using the `page-constructor` directive:

```markdown
::: page-constructor
blocks:

- type: 'header-block'
  title: 'My Header'
  description: 'This is a description'
  :::
```

**Note:** The `blocks:` property is required. Direct list format without the `blocks:` prefix is not supported.

## MarkdownIt transform plugin

Plugin for [@diplodoc/transform](https://github.com/diplodoc-platform/transform) package.

Options:

- `runtime` - name of runtime script and style which will be exposed in results `script` and `style` sections.<br>
  Can be a string (both script and style will use the same name) or an object with separate `script` and `style` properties.<br>
  Default: `{ script: '_assets/page-constructor.js', style: '_assets/page-constructor.css' }`<br>

- `bundle` - boolean flag to enable/disable copying of bundled runtime to target directory.<br>
  Where target directory is `<transformer output option>/<plugin runtime option>`<br>
  Default: `true`<br>

- `assetLinkResolver` - function to resolve asset links (images, videos, etc.) in the page constructor content.<br>
  Signature: `(link: string) => string`<br>
  Default: `undefined`<br>

- `contentLinkResolver` - function to resolve content links (markdown files, HTML files, etc.) in the page constructor content.<br>
  Signature: `(link: string) => string`<br>
  Default: `undefined`<br>

## Prepared runtime

It is necessary to add `runtime` scripts to make page constructor interactive on your page.<br/>
You can add assets files which were generated by the [MarkdownIt transform plugin](#markdownit-transform-plugin).

```html
<html>
  <head>
    <!-- Read more about '_assets/page-constructor.js' and '_assets/page-constructor.css' in 'Transform plugin' section -->
    <script src="_assets/page-constructor.js"></script>
    <link rel="stylesheet" href="_assets/page-constructor.css" />
  </head>
  <body>
    ${result.html}
  </body>
</html>
```

Or you can just include runtime's source code in your bundle.

```js
import '@diplodoc/page-constructor-extension/runtime';
import '@diplodoc/page-constructor-extension/runtime/styles.css';
```

### Rendering Detection

The runtime now automatically detects whether to hydrate or render content based on the content's structure:

- **Server-rendered content** (with pre-rendered HTML) will be hydrated
- **Browser-rendered content** (empty placeholder) will be fully rendered

This allows you to use a single runtime that intelligently determines the appropriate rendering method, simplifying integration in mixed environments where both server and browser rendering are used.

> **Important note about sanitization:**
>
> When using server-side rendering (SSR), all HTML passes through the default sanitizer of the transform.
> However, when rendering on the client side, Page Constructor content is not sanitized automatically.
> If you need this functionality in client-side rendering scenarios, you need to handle content sanitization yourself to prevent potential security issues.

```js
// Import the runtime - it will automatically detect the rendering type
import '@diplodoc/page-constructor-extension/runtime';

// The runtime is initialized automatically, but you can also use the React component
// for more control over the initialization process
import {PageConstructorRuntime} from '@diplodoc/page-constructor-extension/react';

// Use the component in your React application
function App() {
  return (
    <>
      {/* Your content */}
      <PageConstructorRuntime />
    </>
  );
}
```

## React components for rendering

The extension provides React components for rendering page constructor content:

### Direct rendering with createPageConstructorElement

```jsx
import {createPageConstructorElement} from '@diplodoc/page-constructor-extension/react';

// Your page constructor content
const content = {
  blocks: [
    {
      type: 'header-block',
      title: 'My Header',
      description: 'This is a description',
    },
  ],
};

// Render the page constructor
const element = createPageConstructorElement(content);
```

### Using the PageConstructorRuntime component

For automatic initialization and rendering of page constructor elements on the page:

```jsx
import {PageConstructorRuntime} from '@diplodoc/page-constructor-extension/react';

function App() {
  return (
    <>
      {/* Your content with page-constructor elements */}
      <div dangerouslySetInnerHTML={{__html: htmlContent}} />
      
      {/* Add the runtime component to initialize page constructor */}
      <PageConstructorRuntime />
    </>
  );
}
```

### Using hooks for more control

```jsx
import {usePageConstructorController, usePageConstructor} from '@diplodoc/page-constructor-extension/react';

function MyComponent() {
  // Get the controller
  const controller = usePageConstructorController();
  
  // Get the render function
  const renderPageConstructors = usePageConstructor();
  
  // Render page constructors when needed
  useEffect(() => {
    if (controller) {
      renderPageConstructors();
    }
  }, [controller, renderPageConstructors]);
  
  return <div>My Component</div>;
}
```

## Link Resolvers

The `assetLinkResolver` and `contentLinkResolver` options allow you to customize how links are resolved in the page constructor content. These functions are called for each link in the content and should return the resolved link.

- `assetLinkResolver`: Called for links to assets (images, videos, etc.)
- `contentLinkResolver`: Called for links to content (markdown files, HTML files, etc.)

Example:

```js
pageConstructorPlugin({
  // Other options...
  assetLinkResolver: (link) => {
    // Add a prefix to asset links
    return link.startsWith('http') ? link : `/assets/${link}`;
  },
  contentLinkResolver: (link) => {
    // Convert .md links to .html
    return link.endsWith('.md') ? link.replace('.md', '.html') : link;
  },
});
```

## Example

See the `example` directory for a complete example of how to use this extension.
